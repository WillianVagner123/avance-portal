import { PrismaClient } from "@prisma/client";
import { PrismaBetterSqlite3 } from "@prisma/adapter-better-sqlite3";
import Database from "better-sqlite3";

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined;
};

function resolveSqliteFilePath() {
  const url = process.env.DATABASE_URL || "file:./dev.db";

  // Prisma sqlite url é "file:./dev.db" ou "file:../x.db"
  if (url.startsWith("file:")) {
    const p = url.slice("file:".length); // "./dev.db"
    const clean = p.replace(/^\/+/, ""); // remove barras extras
    // nosso repo usa arquivo em prisma/dev.db (onde o migrate criou)
    // então forçamos o caminho "prisma/dev.db" se vier "./dev.db"
    if (clean === "./dev.db" || clean === "dev.db") return "prisma/dev.db";
    if (clean.startsWith("./")) return clean.slice(2);
    return clean;
  }

  // fallback seguro
  return "prisma/dev.db";
}

function makeClient() {
  const filePath = resolveSqliteFilePath();
  const db = new Database(filePath);
  const adapter = new PrismaBetterSqlite3(db);

  return new PrismaClient({
    adapter,
    log: ["error", "warn"],
  });
}

export const prisma = globalForPrisma.prisma ?? makeClient();

if (process.env.NODE_ENV !== "production") globalForPrisma.prisma = prisma;
